@page "/dc_upload"
@using System.Threading.Tasks;
@inject IWebHostEnvironment Environment
@inject SiteDataService objDataService
@inject DcFileService objFileService
@using TspuWebPortal.Model
@using TspuWebPortal.ORM
@using TspuWebPortal.Shared

<h3>Загрузка файла ведомости</h3>
<InputFile OnChange="@UploadExcel" />

@if (IsFileUploaded)
{
    <a>Сохранено в @FilePath </a>
    <p>
        <label>
            <button class="btn btn-primary" @onclick="AddNewFile">Добавить в базу файлов</button>
        </label>
    </p>
}

@if (IsFileAddedToTable)
{
    <a>Добавлена запись в таблицу загруженных файлов.</a>
    <NavLink class="nav-link" href="filedata_navigation">
        <span class="oi oi-plus" aria-hidden="true"></span> Просмотреть таблицу
    </NavLink>
}


@code
{
    string FileName = "";
    DateOnly LastModifiedDate;
    string FileSize = "";
    string ContentType = "";

    string FilePath = "";

    bool IsFileUploaded = false;
    bool IsFileAddedToTable = false;

    async Task UploadExcel(InputFileChangeEventArgs e)
    {
        IBrowserFile LoadedFile = e.File;
        //FileName = $"{LoadedFile.Name}_{DateTime.Now}";                           //Почему не цепляется дата?             
        FileName = $"{LoadedFile.Name}";    
        LastModifiedDate = DateOnly.FromDateTime(LoadedFile.LastModified.DateTime);
        FileSize = LoadedFile.Size.ToString();
        ContentType = LoadedFile.ContentType;
        var trustedFileNameForFileStorage = Path.GetRandomFileName();
        FilePath = Path.Combine(Environment.ContentRootPath,
                        Environment.EnvironmentName, "unsafe_uploads",
                        FileName);
        await using FileStream fs = new(FilePath, FileMode.Create);
        IsFileUploaded = true;
        await LoadedFile.OpenReadStream().CopyToAsync(fs);
    }

    void AddNewFile()
    {
        objFileService.CreateFileModel (new FileData {FileName = this.FileName, UploadDate = DateOnly.FromDateTime(DateTime.Now), LastChangeDate = LastModifiedDate, FilePath = this.FilePath, FileCategory = "Детали", IsAppliedToTable = false});
        IsFileAddedToTable = true;
        //DateTime test1 = LastModifiedDate.DateTime;
    }

}
